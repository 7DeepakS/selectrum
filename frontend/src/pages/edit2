// src/components/AdminView.js
import React, { useState, useEffect, useCallback } from 'react';
import api from '../services/api';

const availableReportColumns = {
    eventName: { label: 'Event Name', defaultChecked: true },
    courseTitle: { label: 'Course Title', defaultChecked: true },
    studentName: { label: 'Student Name', defaultChecked: true },
    studentDepartment: { label: 'Student Department', defaultChecked: true },
    studentUsername: { label: 'Student Username', defaultChecked: false },
    eventIsOpen: { label: 'Event Open', defaultChecked: false },
    courseDescription: { label: 'Course Description', defaultChecked: false },
    slotTime: { label: 'Slot Time', defaultChecked: false },
    slotMaxCapacity: { label: 'Slot Max Capacity', defaultChecked: false },
    slotIsActive: { label: 'Slot Active', defaultChecked: false },
};

function AdminView() {
  const [events, setEvents] = useState([]);
  const [distinctDepartments, setDistinctDepartments] = useState(['all']);
  
  const [selectedEventForStatusTable, setSelectedEventForStatusTable] = useState(''); 
  const [eventStatusByDeptData, setEventStatusByDeptData] = useState(null); 
  
  const [activityLogs, setActivityLogs] = useState([]);
  const [logFilters, setLogFilters] = useState({ username: '', action: '' });
  const [logPagination, setLogPagination] = useState({ currentPage: 1, totalPages: 1, totalLogs: 0 });

  const [uiMessages, setUiMessages] = useState({ error: '', success: '', info: '' });
  const [loadingStates, setLoadingStates] = useState({
    initialData: true,
    fetchingEventEnrollmentStatus: false,
    isFetchingLogs: false,
    isDownloadingLogs: false,
    downloadingCustomDetailedReport: false, 
  });

  const [selectedScopeType, setSelectedScopeType] = useState('department');
  const [selectedDepartmentForDownload, setSelectedDepartmentForDownload] = useState('all');
  const [selectedEventForReport, setSelectedEventForReport] = useState('');
  const [selectedCourseForReport, setSelectedCourseForReport] = useState('');
  const [coursesInSelectedEvent, setCoursesInSelectedEvent] = useState([]);
  const [selectedColumns, setSelectedColumns] = useState(
    Object.entries(availableReportColumns).reduce((acc, [key, val]) => {
        acc[key] = val.defaultChecked;
        return acc;
    }, {})
  );

  const setTimedMessage = (type, message, duration = 7000) => {
    setUiMessages({ error: '', success: '', info: '', [type]: message });
    setTimeout(() => setUiMessages(prev => ({ ...prev, [type]: '' })), duration);
  };

  const fetchDashboardData = useCallback(async () => {
    setLoadingStates(p => ({ ...p, initialData: true }));
    try {
        const [eventsRes, deptsRes] = await Promise.all([
            api.get('events/all'),
            api.get('events/enrollment-summary/by-department').catch(() => null)
        ]);
        if (eventsRes.data.success) setEvents(eventsRes.data.data || []);
        if (deptsRes?.data?.success) {
            let depts = ['all', ...(deptsRes.data.data.distinctDepartments || [])];
            setDistinctDepartments([...new Set(depts)].sort((a,b) => {
                if (a === 'all') return -1; if(b === 'all') return 1;
                if (a === 'N/A') return 1; if(b === 'N/A') return -1;
                return String(a).localeCompare(b);
            }));
        }
    } catch (err) {
        setTimedMessage('error', err.error || 'Failed to load dashboard data.');
    } finally {
        setLoadingStates(p => ({ ...p, initialData: false }));
    }
  }, []);
  
  const fetchActivityLogs = useCallback(async (page = 1) => {
    setLoadingStates(p => ({ ...p, isFetchingLogs: true }));
    try {
        const params = new URLSearchParams({ page, limit: 15 });
        if (logFilters.username) params.append('username', logFilters.username);
        if (logFilters.action) params.append('action', logFilters.action);
        const response = await api.get(`events/activity-logs?${params.toString()}`);
        if (response.data.success) {
            setActivityLogs(response.data.data.logs);
            setLogPagination(response.data.data);
        }
    } catch (err) {
        setTimedMessage('error', err.error || 'Could not fetch logs.');
    } finally {
        setLoadingStates(p => ({ ...p, isFetchingLogs: false }));
    }
  }, [logFilters]);

  useEffect(() => {
    fetchDashboardData();
    fetchActivityLogs();
  }, [fetchDashboardData, fetchActivityLogs]);

  useEffect(() => {
    if (!loadingStates.initialData) fetchActivityLogs(logPagination.currentPage);
  }, [logPagination.currentPage]);

  useEffect(() => { 
      if (selectedScopeType === 'course' || selectedScopeType === 'event') {
          const event = events.find(e => e._id === selectedEventForReport);
          setCoursesInSelectedEvent(event ? (event.courses || []) : []);
          if(selectedScopeType === 'course') setSelectedCourseForReport(''); 
      }
  }, [selectedEventForReport, selectedScopeType, events]);

  useEffect(() => { setEventStatusByDeptData(null); }, [selectedEventForStatusTable]);
  
  const handleFetchEventStatusByDept = async () => {
    if (!selectedEventForStatusTable) { setTimedMessage('error', 'Please select an event.'); return; }
    setLoadingStates(p => ({ ...p, fetchingEventEnrollmentStatus: true }));
    setEventStatusByDeptData(null);
    try {
      const url = `events/${selectedEventForStatusTable}/enrollment-status-by-department`;
      const response = await api.get(url);
      if (response.data.success) {
        setEventStatusByDeptData(response.data.data);
        if (response.data.data.message) setTimedMessage('info', response.data.data.message);
      } else {
        setTimedMessage('error', response.data.error);
      }
    } catch (err) {
      setTimedMessage('error', `Error fetching status: ${err.error || err.message}`);
    } finally {
      setLoadingStates(p => ({ ...p, fetchingEventEnrollmentStatus: false }));
    }
  };

  const handleLogFilterChange = (e) => setLogFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleApplyLogFilters = () => {
    if (logPagination.currentPage !== 1) setLogPagination(p => ({ ...p, currentPage: 1 }));
    else fetchActivityLogs(1);
  };
  const handleLogPageChange = (newPage) => {
    if (newPage > 0 && newPage <= logPagination.totalPages && newPage !== logPagination.currentPage) {
        setLogPagination(p => ({ ...p, currentPage: newPage }));
    }
  };

  const handleColumnToggle = (columnName) => setSelectedColumns(prev => ({ ...prev, [columnName]: !prev[columnName] }));

  const handleDownloadLogs = async () => {
    setLoadingStates(p => ({ ...p, isDownloadingLogs: true }));
    try {
        const params = new URLSearchParams();
        if (logFilters.username) params.append('username', logFilters.username);
        if (logFilters.action) params.append('action', logFilters.action);
        const endpoint = `events/activity-logs/download?${params.toString()}`;
        const response = await api.get(endpoint, { responseType: 'blob' });
        const blob = response.data;
        if (!(blob instanceof Blob)) throw new Error("Response was not a file.");
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        let fileName = response.headers['content-disposition']?.split('filename=')[1]?.replace(/"/g, '') || 'activity_logs.csv';
        link.setAttribute('download', fileName);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        setTimedMessage('success', 'Activity log download started.');
    } catch (err) {
        setTimedMessage('error', err.error || 'Could not download activity logs.');
    } finally {
        setLoadingStates(p => ({ ...p, isDownloadingLogs: false }));
    }
  };

  const handleDownloadCustomDetailedReport = async () => {
    let reportScopePayload = {};
    let scopeDescription = "";
    if (selectedScopeType === 'department') {
        if (!selectedDepartmentForDownload) { setTimedMessage('error', 'Please select a department.'); return; }
        reportScopePayload = { type: 'department', value: selectedDepartmentForDownload };
        scopeDescription = selectedDepartmentForDownload === 'all' ? 'All_Departments' : `Dept_${selectedDepartmentForDownload}`;
    } else if (selectedScopeType === 'event') {
        if (!selectedEventForReport) { setTimedMessage('error', 'Please select an event.'); return; }
        reportScopePayload = { type: 'event', value: selectedEventForReport };
        const eventObj = events.find(e => e._id === selectedEventForReport);
        scopeDescription = eventObj ? `Event_${eventObj.name}` : `Event_${selectedEventForReport}`;
    } else if (selectedScopeType === 'course') {
        if (!selectedEventForReport || !selectedCourseForReport) { setTimedMessage('error', 'Please select an event and a course.'); return; }
        reportScopePayload = { type: 'course', eventId: selectedEventForReport, courseId: selectedCourseForReport };
        const eventObj = events.find(e => e._id === selectedEventForReport);
        const courseObj = coursesInSelectedEvent.find(c => c._id === selectedCourseForReport);
        scopeDescription = `Event_${eventObj?.name}_Course_${courseObj?.title}`;
    } else { setTimedMessage('error', 'Invalid report scope.'); return; }

    const activeColumns = Object.entries(selectedColumns).filter(([, value]) => value).map(([key]) => key);
    if (activeColumns.length === 0) { setTimedMessage('error', 'Please select at least one column.'); return; }

    setLoadingStates(p => ({ ...p, downloadingCustomDetailedReport: true }));
    try {
        const endpoint = `events/download/custom-detailed`;
        const response = await api.post(endpoint, { scope: reportScopePayload, columns: activeColumns }, { responseType: 'blob' });
        const blob = response.data;
        if (!(blob instanceof Blob)) throw new Error('Response was not a Blob.');
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        let fileName = response.headers['content-disposition']?.split('filename=')[1]?.replace(/"/g, '') || `report_${scopeDescription.replace(/[^\w-]/g, '_')}.csv`;
        link.setAttribute('download', fileName);
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        setTimedMessage('success', `Custom report download started.`);
    } catch (err) {
        setTimedMessage('error', `Custom report download error: ${err.error || err.message}`);
    } finally {
        setLoadingStates(p => ({ ...p, downloadingCustomDetailedReport: false }));
    }
  };

  if (loadingStates.initialData) {
    return <div className="p-4 text-center">Loading Dashboard Data...</div>;
  }

  return (
    <div className="space-y-8">
      {uiMessages.error && <p className="p-3 my-4 bg-red-100 text-red-700 rounded-md">{uiMessages.error}</p>}
      {uiMessages.success && <p className="p-3 my-4 bg-green-100 text-green-700 rounded-md">{uiMessages.success}</p>}
      {uiMessages.info && <p className="p-3 my-4 bg-blue-100 text-blue-700 rounded-md">{uiMessages.info}</p>}
      
      <section className="p-6 bg-white rounded-xl shadow-lg">
        <h2 className="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">Event Enrollment Status by Department</h2>
        <div className="sm:flex sm:space-x-4 mb-4 items-end">
            <div className="flex-1 mb-4 sm:mb-0">
                <label htmlFor="eventStatusTableSelect" className="block text-sm font-medium text-gray-700 mb-1">Select Event:</label>
                <select id="eventStatusTableSelect" value={selectedEventForStatusTable} onChange={(e) => setSelectedEventForStatusTable(e.target.value)} className="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="">-- Select Event --</option>
                    {events.map(event => <option key={event._id} value={event._id}>{event.name}</option>)}
                </select>
            </div>
            <button onClick={handleFetchEventStatusByDept} disabled={!selectedEventForStatusTable || loadingStates.fetchingEventEnrollmentStatus} className="w-full sm:w-auto p-3 bg-cyan-600 text-white rounded-lg disabled:opacity-50">
                {loadingStates.fetchingEventEnrollmentStatus ? "Loading..." : "View Status"}
            </button>
        </div>
        {loadingStates.fetchingEventEnrollmentStatus && <p className="mt-4 text-center animate-pulse">Fetching status...</p>}
        {eventStatusByDeptData && !loadingStates.fetchingEventEnrollmentStatus && (
            <div className="mt-6">
                <h3 className="text-xl font-semibold text-gray-800 mb-3">Status for: <span className="text-indigo-600">{eventStatusByDeptData.eventName}</span></h3>
                {(eventStatusByDeptData.departmentalStatus || []).length > 0 ? (
                    <div className="overflow-x-auto shadow border-b rounded-lg">
                        <table className="min-w-full divide-y divide-gray-200"><thead className="bg-gray-100"><tr>
                            <th className="px-6 py-3 text-left text-xs font-bold uppercase">Department</th>
                            <th className="px-6 py-3 text-center text-xs font-bold uppercase">Total Students</th>
                            <th className="px-6 py-3 text-center text-xs font-bold uppercase">Enrolled</th>
                            <th className="px-6 py-3 text-center text-xs font-bold uppercase">Not Enrolled</th>
                            <th className="px-6 py-3 text-center text-xs font-bold uppercase">% Enrolled</th>
                        </tr></thead><tbody className="bg-white divide-y">
                        {eventStatusByDeptData.departmentalStatus.map((d) => (
                            <tr key={d.department} className="hover:bg-gray-50">
                                <td className="px-6 py-4 font-medium">{d.department}</td>
                                <td className="px-6 py-4 text-center">{d.total_students}</td>
                                <td className="px-6 py-4 text-green-700 font-medium text-center">{d.signed_in_students}</td>
                                <td className="px-6 py-4 text-red-700 font-medium text-center">{d.not_signed_in_students}</td>
                                <td className="px-6 py-4 text-center">{d.percentage_signed_in}%</td>
                            </tr>
                        ))}</tbody></table>
                    </div>
                ) : <p className="mt-4 text-gray-500">No departmental enrollment data to display for this event.</p>}
            </div>
        )}
      </section>
      
      <section className="p-6 bg-white rounded-xl shadow-lg">
        <h2 className="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">Download Reports</h2>
        <div className="p-4 border-2 border-indigo-200 rounded-lg bg-indigo-50">
            <h3 className="text-xl font-semibold mb-3 text-indigo-700">Custom Detailed Enrollment Report</h3>
            <div className="mb-4">
                <label htmlFor="customReportScopeType" className="block text-sm font-medium text-gray-700 mb-1">Filter Report By:</label>
                <select id="customReportScopeType" value={selectedScopeType}
                    onChange={(e) => {
                        setSelectedScopeType(e.target.value);
                        setSelectedDepartmentForDownload('all'); 
                        setSelectedEventForReport(''); 
                        setSelectedCourseForReport('');
                    }}
                    className="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="department">Department</option>
                    <option value="event">Event</option>
                    <option value="course">Specific Course (within Event)</option>
                </select>
            </div>

            {selectedScopeType === 'department' && (
                <div className="mb-4">
                    <label htmlFor="customReportDepartment" className="block text-sm font-medium text-gray-700 mb-1">Department:</label>
                    <select id="customReportDepartment" value={selectedDepartmentForDownload}
                        onChange={(e) => setSelectedDepartmentForDownload(e.target.value)}
                        className="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        {distinctDepartments.map(dept => (
                            <option key={dept} value={dept}>{dept === 'all' ? 'All Departments' : (dept === 'N/A' ? 'N/A (No Dept.)' : dept)}</option>
                        ))}
                    </select>
                </div>
            )}

            {(selectedScopeType === 'event' || selectedScopeType === 'course') && (
                <div className="mb-4">
                    <label htmlFor="customReportEvent" className="block text-sm font-medium text-gray-700 mb-1">Event:</label>
                    <select id="customReportEvent" value={selectedEventForReport}
                        onChange={(e) => setSelectedEventForReport(e.target.value)}
                        className="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        required={selectedScopeType === 'event' || selectedScopeType === 'course'}>
                        <option value="">-- Select Event --</option>
                        {events.map(event => (<option key={event._id} value={event._id}>{event.name}</option>))}
                    </select>
                </div>
            )}

            {selectedScopeType === 'course' && selectedEventForReport && (
                <div className="mb-4">
                    <label htmlFor="customReportCourse" className="block text-sm font-medium text-gray-700 mb-1">Course:</label>
                    <select id="customReportCourse" value={selectedCourseForReport}
                        onChange={(e) => setSelectedCourseForReport(e.target.value)}
                        disabled={!selectedEventForReport || coursesInSelectedEvent.length === 0}
                        className="w-full sm:w-auto p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                        required={selectedScopeType === 'course'}>
                        <option value="">-- Select Course --</option>
                        {coursesInSelectedEvent.map(course => (<option key={course._id} value={course._id}>{course.title}</option>))}
                    </select>
                    {selectedEventForReport && coursesInSelectedEvent.length === 0 && <p className="text-xs text-gray-500 mt-1">No courses found in the selected event.</p>}
                </div>
            )}

            <div className="mb-4">
                <h4 className="text-md font-medium mb-2 text-gray-700">Select Columns to Include:</h4>
                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-x-4 gap-y-2">
                    {Object.entries(availableReportColumns).map(([colKey, colConfig]) => (
                        <label key={colKey} className="flex items-center space-x-2 text-sm text-gray-600 hover:text-gray-900 cursor-pointer">
                            <input type="checkbox" checked={selectedColumns[colKey]} onChange={() => handleColumnToggle(colKey)}
                                className="form-checkbox h-4 w-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-400"/>
                            <span>{colConfig.label}</span>
                        </label>
                    ))}
                </div>
            </div>
            
            <button onClick={handleDownloadCustomDetailedReport} 
                className="w-full p-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition disabled:opacity-50"
                disabled={loadingStates.downloadingCustomDetailedReport || 
                          (selectedScopeType === 'department' && !selectedDepartmentForDownload) ||
                          (selectedScopeType === 'event' && !selectedEventForReport) ||
                          (selectedScopeType === 'course' && (!selectedEventForReport || !selectedCourseForReport))
                         }>
                {loadingStates.downloadingCustomDetailedReport ? 'Generating Custom Report...' : 'Download Custom Detailed Report'}
            </button>
        </div>
      </section>

      <section className="p-6 bg-white rounded-xl shadow-lg">
  <h2 className="text-2xl font-semibold mb-4 text-gray-700 border-b pb-2">User Activity Logs</h2>
  
  <div className="p-4 mb-4 bg-gray-50 rounded-lg border flex flex-col sm:flex-row gap-4 items-center flex-wrap">
      <div className="flex-grow w-full sm:w-auto">
          <label htmlFor="logFilterUsername" className="text-sm font-medium text-gray-700">Filter by Username</label>
          <input
              id="logFilterUsername" type="text" name="username" value={logFilters.username}
              onChange={handleLogFilterChange} placeholder=""
              className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
          />
      </div>
      <div className="flex-grow w-full sm:w-auto">
          <label htmlFor="logFilterAction" className="text-sm font-medium text-gray-700">Filter by Action</label>
          <select
              id="logFilterAction" name="action" value={logFilters.action} onChange={handleLogFilterChange}
              className="mt-1 w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
              <option value="">All Actions</option>
              <option value="LOGIN_SUCCESS">Login Success</option>
              <option value="ENROLL_SUCCESS">Enroll Success</option>
              <option value="ENROLL_FAIL">Enroll Fail</option>
          </select>
      </div>
      <div className="flex-shrink-0 pt-6 flex space-x-2">
           <button onClick={handleApplyLogFilters} className="p-2 h-10 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:opacity-50" disabled={loadingStates.isFetchingLogs}>
              {loadingStates.isFetchingLogs ? 'Searching...' : 'Search'}
          </button>
          <button onClick={handleDownloadLogs} className="p-2 h-10 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:opacity-50" disabled={loadingStates.isDownloadingLogs}>
              {loadingStates.isDownloadingLogs ? '...' : 'Download CSV'}
          </button>
      </div>
  </div>

  <div className="overflow-x-auto">
    <table className="min-w-full divide-y divide-gray-200">
      <thead className="bg-gray-50">
        <tr>
          <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
          <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
          <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
          <th scope="col" className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
        </tr>
      </thead>
      <tbody className="bg-white divide-y divide-gray-200">
        {loadingStates.isFetchingLogs ? (
            <tr><td colSpan="4" className="text-center p-4 animate-pulse">Loading logs...</td></tr>
        ) : activityLogs.length === 0 ? (
            <tr><td colSpan="4" className="text-center p-4 text-gray-500">No logs found for the current filter.</td></tr>
        ) : (
          activityLogs.map(log => (
            <tr key={log._id} className="hover:bg-gray-50">
              <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-500">{new Date(log.createdAt).toLocaleString()}</td>
              <td className="px-4 py-4 whitespace-nowrap">
                  <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                      log.action.includes('SUCCESS') ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                      {log.action}
                  </span>
              </td>
              <td className="px-4 py-4 whitespace-nowrap text-sm text-gray-900">
                  <div>{log.user?.name || log.username}</div>
                  <div className="text-xs text-gray-500">{log.user?.department || 'N/A'}</div>
              </td>
              {/* ======================= THE FIX IS HERE ======================= */}
              <td className="px-4 py-4 whitespace-normal text-sm text-gray-500">
                {/* Always check if log.details exists before trying to access its properties */}
                {log.details && (
                  <>
                    {log.details.ip && <div>IP: {log.details.ip}</div>}
                    {log.details.eventName && <div>Event: {log.details.eventName}</div>}
                    {log.details.courseTitle && <div>Course: {log.details.courseTitle}</div>}
                    {log.details.errorMessage && <div className="text-red-600">Error: {log.details.errorMessage}</div>}
                  </>
                )}
              </td>
              {/* ===================== END OF THE FIX ====================== */}
            </tr>
          ))
        )}
      </tbody>
    </table>
  </div>
  <div className="mt-4 flex items-center justify-between">
      <p className="text-sm text-gray-700">
          Page {logPagination.currentPage} of {logPagination.totalPages} ({logPagination.totalLogs} total logs)
      </p>
      <div className="space-x-2">
          <button 
              onClick={() => handleLogPageChange(logPagination.currentPage - 1)}
              disabled={logPagination.currentPage <= 1 || loadingStates.isFetchingLogs}
              className="p-2 border rounded-md text-sm disabled:opacity-50"
          >
              Previous
          </button>
          <button 
              onClick={() => handleLogPageChange(logPagination.currentPage + 1)}
              disabled={logPagination.currentPage >= logPagination.totalPages || loadingStates.isFetchingLogs}
              className="p-2 border rounded-md text-sm disabled:opacity-50"
          >
              Next
          </button>
      </div>
  </div>
</section>
    </div>
  );
}
export default AdminView;